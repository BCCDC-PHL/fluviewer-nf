BootStrap: docker
From: python:3.9-slim

%files
    environment.yml /opt/environment.yml

%post
    # Install system dependencies
    apt-get update && apt-get install -y \
        wget \
        bzip2 \
        procps \
        ca-certificates \
        git \
        && apt-get clean \
        && rm -rf /var/lib/apt/lists/*

    # Install Miniforge
    wget -q https://github.com/conda-forge/miniforge/releases/latest/download/Miniforge3-Linux-x86_64.sh && \
    bash Miniforge3-Linux-x86_64.sh -b -f -p /opt/mamba && \
    rm Miniforge3-Linux-x86_64.sh

    # Add conda to PATH
    . /opt/mamba/bin/activate

    # Initialize mamba	
    mamba init
    . /root/.bashrc

    # Create conda environment
    mamba env create -f /opt/environment.yml

    # Clean up
    mamba clean -afy


%environment
	. /root/.bashrc && \
    export CONDA_ENV_NAME=$(head -n1 /opt/environment.yml | cut -d' ' -f2)  && \
    mamba activate $CONDA_ENV_NAME

%runscript
    exec "$@"